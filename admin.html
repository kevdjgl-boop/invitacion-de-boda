<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel Admin | Boda M&K</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap");
      body {
        font-family: "Montserrat", sans-serif;
        background-color: #f3f4f6;
      }
      .card-shadow {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }
    </style>
  </head>
  <body class="text-gray-800">
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex items-center gap-2">
            <i class="ph-fill ph-rings-wedding text-orange-500 text-3xl"></i>
            <h1 class="text-xl font-bold tracking-tight text-gray-900">Admin Boda M&K</h1>
          </div>
          <div class="flex items-center">
            <a href="index.html" target="_blank" class="text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1"> Ver Invitación <i class="ph ph-arrow-square-out"></i> </a>
          </div>
        </div>
      </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-xl p-6 card-shadow border-l-4 border-blue-500">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500">Total Regalos</p>
              <p class="text-3xl font-bold text-gray-900" id="stat-total">0</p>
            </div>
            <div class="p-3 bg-blue-50 rounded-full text-blue-600"><i class="ph ph-gift text-2xl"></i></div>
          </div>
        </div>
        <div class="bg-white rounded-xl p-6 card-shadow border-l-4 border-green-500">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500">Comprados</p>
              <p class="text-3xl font-bold text-green-600" id="stat-bought">0</p>
            </div>
            <div class="p-3 bg-green-50 rounded-full text-green-600"><i class="ph ph-check-circle text-2xl"></i></div>
          </div>
        </div>
        <div class="bg-white rounded-xl p-6 card-shadow border-l-4 border-orange-400">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500">Disponibles</p>
              <p class="text-3xl font-bold text-orange-500" id="stat-available">0</p>
            </div>
            <div class="p-3 bg-orange-50 rounded-full text-orange-500"><i class="ph ph-shopping-cart text-2xl"></i></div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="lg:col-span-1">
          <div class="bg-white rounded-xl card-shadow p-6 sticky top-24 border border-gray-100">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2" id="form-title">
                <i class="ph ph-plus-circle text-orange-500"></i> Agregar Nuevo Regalo
            </h2>
            
            <form id="form-admin-regalo" class="space-y-4">
              <input type="hidden" id="edit-id" value="">

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Producto</label>
                <input type="text" id="admin-nombre" class="w-full rounded-lg border-gray-300 border p-2.5 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition shadow-sm" placeholder="Ej: Licuadora Oster" required />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Precio (Aprox)</label>
                <div class="relative mt-1 rounded-md shadow-sm">
                  <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                    <span class="text-gray-500 sm:text-sm font-bold">S/</span>
                  </div>
                  <input type="number" step="0.01" id="admin-precio" class="block w-full rounded-lg border-gray-300 pl-10 p-2.5 focus:border-orange-500 focus:ring-orange-500 sm:text-sm border" placeholder="150.00" required />
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Enlace (Link)</label>
                <input type="url" id="admin-link" class="w-full rounded-lg border-gray-300 border p-2.5 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition shadow-sm" placeholder="https://..." required />
              </div>

              <div class="flex gap-2">
                  <button type="submit" id="btn-admin-guardar" class="flex-1 bg-gray-900 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600 transition-colors duration-200 flex justify-center items-center gap-2">
                    <span id="btn-text">Guardar Regalo</span>
                    <i class="ph ph-paper-plane-right"></i>
                  </button>
                  
                  <button type="button" id="btn-cancelar-edit" class="hidden px-4 py-3 bg-gray-200 text-gray-700 font-bold rounded-lg hover:bg-gray-300 transition" onclick="cancelarEdicion()">
                    <i class="ph-bold ph-x"></i>
                  </button>
              </div>
            </form>
          </div>
        </div>

        <div class="lg:col-span-2">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-gray-800">Lista Actual</h2>
            <span class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded-full animate-pulse">● En vivo</span>
          </div>

          <div id="admin-lista-container" class="grid grid-cols-1 gap-4">
            <div class="text-center py-10 text-gray-500">Cargando datos...</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyDtwlvV5GiZs_k827RTw8KRq4KZw9UthVw",
        authDomain: "boda-e2a20.firebaseapp.com",
        projectId: "boda-e2a20",
        storageBucket: "boda-e2a20.firebasestorage.app",
        messagingSenderId: "766114888160",
        appId: "1:766114888160:web:235c92c8d6ecdb78cc5385",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      const form = document.getElementById("form-admin-regalo");
      const listaContainer = document.getElementById("admin-lista-container");
      
      const editIdInput = document.getElementById("edit-id");
      const btnGuardar = document.getElementById("btn-admin-guardar");
      const btnGuardarTexto = document.getElementById("btn-text");
      const btnCancelar = document.getElementById("btn-cancelar-edit");
      const formTitle = document.getElementById("form-title");

      const statTotal = document.getElementById("stat-total");
      const statBought = document.getElementById("stat-bought");
      const statAvailable = document.getElementById("stat-available");

      db.collection("regalos")
        .orderBy("nombre")
        .onSnapshot(
          (snapshot) => {
            renderizarLista(snapshot);
            actualizarEstadisticas(snapshot);
          },
          (error) => {
            console.error("Error obteniendo regalos:", error);
            listaContainer.innerHTML = `<div class="bg-red-100 text-red-700 p-4 rounded">Error de conexión: ${error.message}</div>`;
          }
        );

      function renderizarLista(snapshot) {
        listaContainer.innerHTML = ""; 

        if (snapshot.empty) {
          listaContainer.innerHTML = '<div class="text-center py-10 bg-white rounded-xl">No hay regalos registrados aún.</div>';
          return;
        }

        snapshot.forEach((doc) => {
          const regalo = doc.data();
          const id = doc.id;

          const safeNombre = regalo.nombre.replace(/'/g, "\\'");
          const safePrecio = regalo.precio.replace(/'/g, "\\'");
          const safeLink = regalo.link.replace(/'/g, "\\'");

          const statusColor = regalo.comprado ? "bg-green-100 border-green-500" : "bg-white border-transparent";
          const opacity = regalo.comprado ? "opacity-75" : "opacity-100";
          const icon = regalo.comprado ? '<i class="ph-fill ph-check-circle text-green-600 text-xl"></i>' : '<i class="ph ph-circle text-gray-300 text-xl"></i>';

          const cardHTML = `
                <div class="relative group flex flex-col sm:flex-row items-center justify-between p-4 rounded-xl shadow-sm border-l-4 ${statusColor} bg-white hover:shadow-md transition-all duration-200 ${opacity}">
                    
                    <div class="flex items-center gap-4 w-full sm:w-auto overflow-hidden">
                        <div class="flex-shrink-0">
                            ${icon}
                        </div>
                        <div class="min-w-0">
                            <p class="text-lg font-bold text-gray-900 truncate">${regalo.nombre}</p>
                            <div class="flex items-center gap-2 text-sm text-gray-500">
                                <span class="bg-gray-100 px-2 py-0.5 rounded text-gray-700 font-medium">${regalo.precio}</span>
                                <a href="${regalo.link}" target="_blank" class="text-blue-500 hover:underline flex items-center gap-1">Link <i class="ph-bold ph-arrow-up-right"></i></a>
                            </div>
                            ${regalo.comprado ? '<span class="inline-block mt-1 text-xs font-bold text-green-700 bg-green-200 px-2 py-0.5 rounded-full">COMPRADO</span>' : '<span class="inline-block mt-1 text-xs font-bold text-orange-600 bg-orange-100 px-2 py-0.5 rounded-full">DISPONIBLE</span>'}
                        </div>
                    </div>

                    <div class="mt-4 sm:mt-0 flex items-center gap-2 w-full sm:w-auto justify-end border-t sm:border-t-0 pt-3 sm:pt-0 border-gray-100">
                        <button onclick="prepararEdicion('${id}', '${safeNombre}', '${safePrecio}', '${safeLink}')" class="text-gray-400 hover:text-blue-600 p-2 rounded-lg hover:bg-blue-50 transition" title="Editar">
                            <i class="ph-bold ph-pencil-simple text-xl"></i>
                        </button>
                        ${
                          regalo.comprado
                            ? `<button onclick="marcarDisponible('${id}')" class="text-gray-400 hover:text-yellow-600 p-2 rounded-lg hover:bg-yellow-50 transition" title="Resetear">
                                <i class="ph-bold ph-arrow-counter-clockwise text-xl"></i>
                            </button>`
                            : ""
                        }
                        <button onclick="eliminarRegalo('${id}', '${safeNombre}')" class="text-gray-400 hover:text-red-500 p-2 rounded-lg hover:bg-red-50 transition" title="Eliminar">
                            <i class="ph-bold ph-trash text-xl"></i>
                        </button>
                    </div>
                </div>
                `;
          listaContainer.innerHTML += cardHTML;
        });
      }

      function actualizarEstadisticas(snapshot) {
        const total = snapshot.size;
        let comprados = 0;
        snapshot.forEach((doc) => { if (doc.data().comprado) comprados++; });
        statTotal.innerText = total;
        statBought.innerText = comprados;
        statAvailable.innerText = total - comprados;
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const nombre = document.getElementById("admin-nombre").value;
        const link = document.getElementById("admin-link").value;
        const editId = editIdInput.value;
        
        // 1. OBTENER PRECIO Y FORMATEAR AUTOMÁTICAMENTE
        let precioInput = document.getElementById("admin-precio").value;
        
        // Si el usuario escribe "150", lo guardamos como "S/. 150"
        let precioFinal = "";
        if (precioInput.includes("S/.")) {
            precioFinal = precioInput; // Ya tiene el símbolo
        } else {
            precioFinal = "S/. " + precioInput; // Agregamos el símbolo
        }

        btnGuardar.disabled = true;
        const textoOriginal = btnGuardarTexto.innerText;
        btnGuardarTexto.innerText = "Procesando...";

        try {
          if (editId) {
            await db.collection("regalos").doc(editId).update({
                nombre: nombre,
                precio: precioFinal, // Guardamos con S/.
                link: link
            });
            cancelarEdicion();
          } else {
            await db.collection("regalos").add({
              nombre: nombre,
              link: link,
              precio: precioFinal, // Guardamos con S/.
              comprado: false,
              creado: firebase.firestore.FieldValue.serverTimestamp(),
            });
            form.reset();
          }
        } catch (error) {
          console.error(error);
          alert("Error: " + error.message);
        } finally {
          btnGuardar.disabled = false;
          if(!editId) btnGuardarTexto.innerText = "Guardar Regalo"; 
        }
      });

      // --- FUNCIONES GLOBALES ---

      window.prepararEdicion = (id, nombre, precio, link) => {
          document.getElementById("admin-nombre").value = nombre;
          
          // 2. LIMPIAR PRECIO AL EDITAR
          // Quitamos el "S/. " para que el input type="number" lo acepte
          // y el usuario solo vea el número para editar.
          let precioLimpio = precio.replace("S/. ", "").replace("S/.", "").trim();
          document.getElementById("admin-precio").value = precioLimpio;
          
          document.getElementById("admin-link").value = link;
          editIdInput.value = id;

          formTitle.innerHTML = '<i class="ph ph-pencil-simple text-blue-500"></i> Editando Regalo';
          btnGuardarTexto.innerText = "Actualizar Regalo";
          btnGuardar.classList.remove("bg-gray-900", "hover:bg-orange-600");
          btnGuardar.classList.add("bg-blue-600", "hover:bg-blue-700");
          
          btnCancelar.classList.remove("hidden");
          window.scrollTo({ top: 0, behavior: 'smooth' });
      };

      window.cancelarEdicion = () => {
          form.reset();
          editIdInput.value = "";
          formTitle.innerHTML = '<i class="ph ph-plus-circle text-orange-500"></i> Agregar Nuevo Regalo';
          btnGuardarTexto.innerText = "Guardar Regalo";
          btnGuardar.classList.add("bg-gray-900", "hover:bg-orange-600");
          btnGuardar.classList.remove("bg-blue-600", "hover:bg-blue-700");
          btnCancelar.classList.add("hidden");
      };

      window.eliminarRegalo = async (id, nombre) => {
        if (confirm(`¿Estás seguro de ELIMINAR "${nombre}"?\nEsta acción no se puede deshacer.`)) {
            if(editIdInput.value === id) cancelarEdicion();
            try { await db.collection("regalos").doc(id).delete(); } 
            catch (error) { alert("Error: " + error.message); }
        }
      };

      window.marcarDisponible = async (id) => {
        if (confirm(`¿Quieres marcar este regalo como DISPONIBLE nuevamente?`)) {
          try { await db.collection("regalos").doc(id).update({ comprado: false }); } 
          catch (error) { alert("Error: " + error.message); }
        }
      };
    </script>
  </body>
</html>
